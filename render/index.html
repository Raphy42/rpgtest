<!DOCTYPE html>
<html>
	<head>
	<meta charset="UTF-8">
	<title>Hello World!</title>
	<style>
	body {
		/*margin: 0px;*/
		/*overflow: hidden;*/
	}

	.konvajs-content, .bordered {
		border: 1px dashed red;
	}

	.img {
		/*border: 1px dashed green;*/
		width: 100px;
		height: 100px;
		margin: 4px;
		padding: 8px;
	}

	</style>

	<script type="text/javascript" src="bower_components/simplexnoise.js/fast-simplex-noise.js"></script>
	<script type="text/javascript" src="bower_components/konva/konva.min.js"></script>
	<script type="text/javascript" src="scripts/map.js"></script>
	</head>
	<body>
	<div id="container1"></div>
	<div id="container2"></div>
	<script type="text/javascript">

	var resolution = 21
	var size = 10
	let draw = ({f, color}) => new Promise( (res, rej) => {
		var canvas = document.createElement('canvas')
		canvas.width = resolution * size
		canvas.height = resolution * size

		var resol = Math.floor( (resolution / 2) )
		var ctx = canvas.getContext('2d');

		for (var i = -resol; i <= resol; i += 1) {
		for (var j = -resol; j <= resol; j += 1) {

			if (f(i, j))
			ctx.fillStyle = color || "rgba(0, 255, 0, 255)";
			else
			ctx.fillStyle = "rgba(0, 0, 0, 0)";

			ctx.fillRect(
			(i + resol) * size,
			(j + resol) * size,
			size,
			size);
		}
		}

		var dataURL = canvas.toDataURL();
		var image = new Image()
		image.setAttribute('class', 'img')
		image.onload = () => res(image)
		image.src = dataURL

	})

	// var stage = new Konva.Stage({
	//   container: 'container',
	//   width: 800,
	//   height: 600
	// })

	// var layer = new Konva.Layer()
	// stage.add(layer)

	let append = (e) => {
		document.body.appendChild(e)
	}

	let appendFirst = (e) => {
		document.body.insertBefore(e, document.body.firstChild)
	}

	let appendCanvas = (e) => {
		let i = new Konva.Image({
		image: e
		})

		i.draggable(true)

		layer.add(i)
		layer.draw()
	}

	let functions = [
		(i) => ({
		color: 'red',
		f: (x, y) => Math.cos(x * x + y * y) > i
		}),
		// (i) => ({
		//   color: 'blue',
		//   f: (x, y) => Math.cos(x * x + y * y) < i
		// }),
		(i) => ({
		color: 'green',
		f: (x, y) => Math.sin(x * x + y * y) / y > i
		}),
		// (i) => ({
		//   color: 'purple',
		//   f: (x, y) => Math.sin(x * x + y * y) / y < i
		// }),
		// (i) => ({
		//   color: 'magenta',
		//   f: (x, y) => Math.sin(x * x + y * y) < i && Math.cos(x * x + y * y) < i
		// }),
		// (i) => ({
		//   color: 'pink',
		//   f: (x, y) => Math.sin(x * x + y * y) > i && Math.cos(x * x + y * y) > i
		// })
	]

	// functions.map( (e) => {
	//   for (var i = 0; i <= 1; i += 0.1) {
	//     draw(e(i)).then( appendFirst )
	//   }
	// } )

	var resolution = 100
	var size = 2
	let draw2 = ({f, color}) => new Promise( (res, rej) => {
		var canvas = document.createElement('canvas')
		canvas.width = resolution
		canvas.height = resolution

		var resol = resolution
		var ctx = canvas.getContext('2d');

		ctx.fillStyle = color || "rgba(0, 0, 0, 255)";
		for (var i = 0; i <= resol; i += 1) {
			let j = canvas.height - f(i / resol) * resol

			ctx.fillRect(
			i,
			j,
			size,
			size);
		}

		var dataURL = canvas.toDataURL();
		var image = new Image()
		image.onload = () => res(image)
		image.src = dataURL
	})

	let interpolations = [
		(x1, y1) => (x2, y2) => (x) => y1 + (y2 - y1) * ( (x - x1) / (x2 - x1) ),
		(x1, y1) => (x2, y2) => (x) => {
			var mu2 = ( 1 - Math.cos(x * Math.PI) ) / 2;
			return y1 * (1 - mu2) + y2 * mu2;
		}
	]

	// interpolations.concat([
	//   (x) => x,
	//   (x) => Math.log(x + 1),
	//   (x) => Math.cos(x),
	//   (x) => Math.cos(x + 1),
	//   (x) => x * x
	// ])

	// interpolations.map( (e) => {
	//   draw2( e ).then( append )
	// } )

	let points = [
		{ x1: 0.1, y1: 0.1, x2: 0.8, y2: 0.6 },
		{ x1: 0.1, y1: 0.1, x2: 0.8, y2: 0.7 },
		{ x1: 0.1, y1: 0.1, x2: 0.8, y2: 0.2 },
	]

	points.forEach( ({x1, y1, x2, y2}) => {
	  interpolations.forEach( (i) => {
	    draw2( {f: i(x1, y1)(x2, y2)} ).then( append )
	  })
	})

	// let m = new Map( new FastSimplexNoise() )

	// console.log(m)
	// let M = m(0, 0, 10, 10)
	// let noise = new FastSimplexNoise()

	var resolution = 400
	var size = 16
	var x = 0
	var y = 0

	let drawCanvas = ({x, y, ctx, resolution, size, f}) => {
		for (var i = 0; i <= resolution / size; i += 1) {
			for (var j = 0; j <= resolution / size; j += 1) {
				let z = f(i + x, j + y)

				if (z < 0.3)
					ctx.fillStyle = "#0D484E";
				else if (z < 0.6)
					ctx.fillStyle = "#10631A";
				else if (z < 1)
					ctx.fillStyle = "#804715";

				ctx.fillRect(i * size, j * size, size, size)
			}
		}
	}

	let draw3 = ({f, color}) => new Promise( (res, rej) => {
		var canvas = document.createElement('canvas')
		var infos = document.createElement('div')

		let fillInfos = () => {
			infos.innerText = "size: " + size + '\n' +
				"x: " + x + '\n' +
				"y: " + y + '\n'
		}
		fillInfos()
		document.body.appendChild(infos)

		canvas.width = resolution
		canvas.height = resolution

		var ctx = canvas.getContext('2d');
		drawCanvas({
			x, y,
			ctx: canvas.getContext('2d'),
			resolution,
			size,
			f
		})

		canvas.addEventListener('mousewheel', (e) => {
			let sign = e.deltaY < 0 ? -1 : 1
			size += sign
			if (size <= 4) {
				size = 4
			}
			else {
				x = Math.trunc( (e.layerX / size) * sign / 2 )
				y = Math.trunc( (e.layerY / size) * sign / 2 )
			}

			fillInfos()
			drawCanvas({
				x, y,
				ctx: canvas.getContext('2d'),
				resolution,
				size,
				f
			})
		})

		res(canvas)

		// var dataURL = canvas.toDataURL();
		// var image = new Image()
		// // image.style.imageRendering = 'pixelated';
		// image.onload = () => res(image)
		// image.src = dataURL
	} )

	let noise = new FastSimplexNoise()
	var map = new Map( { noise, size: 1 } )

	let makeC = (container, f) => {
		var stage = new Konva.Stage({
		  container: container,
		  width: resolution,
		  height: resolution
		})

		var layer = new Konva.Layer()

		var data = []

		for (var i = 0; i <= resolution / size; i += 1) {
			for (var j = 0; j <= resolution / size; j += 1) {
				let color = 'rgba(0, 0, 0, 0)'
				let z = f(i + x, j + y)

				if (z < 0.3)
					color = "#0D484E";
				else if (z < 0.6) {
					color = "#10631A";
				}
				else if (z < 1)
					color = "#804715";

				data.push( new Konva.Rect({
				  x: i * size,
				  y: j * size,
				  width: size,
				  height: size,
				  fill: color,
				}))

				// ctx.fillRect(i * size, j * size, size, size)
			}
		}

		// layer.on('wheel', (e) => console.log(e))

		data.forEach( (e) => layer.add(e))
		stage.add(layer)
		layer.draw()
	}

	makeC('container1', map.get)
	makeC('container2', map.getSinInterpolate)

	console.log(map.get(0, 0))
	console.log(map.get(0.2, 0.2))
	console.log(map.get(0.5, 0.5))
	console.log(map.get(1, 1))

	// draw3({ f: map.get }).then(append)
	// draw3({ f: map.getNearest(1) }).then(append)
	// draw3({ f: map.getNearest(2) }).then(append)
	// var map = new Map( { noise, size: 2 } )
	// draw3({ f: map.get }).then(append)
	// draw3({ f: map.getNearest(1) }).then(append)
	// draw3({ f: map.getNearest(2) }).then(append)

	</script>
	</body>
</html>
