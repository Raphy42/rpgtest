<link rel=import href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel=import href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel=import href="../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-styles/demo-pages.html">

<dom-module id="adebray-character-card">
	<template>
		<style>
			:host {
				/*padding: 10%;*/
				margin: 4px;
				/*border: 1px dashed red;*/
				display: block;
				/*background-image: url("../ui/frame.png");*/
				background-repeat: no-repeat;
				background-size: cover;
				image-rendering: pixelated;

				min-width: 350px;
			}

			.initial {
				display: initial;
			}

			.inline {
				display: inline-block;
			}

			.horizontal {
				@apply(--layout-horizontal);
			}
			.vertical {
				@apply(--layout-vertical);
			}
			.head {
				@apply(--layout-start);
			}
			.flexchild {
		      @apply(--layout-flex);
		    }

			.green {
				display: block;
				border: 1px dashed green;
			}

			adebray-skill-tree, .bordered {
				border: 1px solid black;
			}
		</style>

		<img id=start src=../ui/jauge_start.png on-load='test' hidden></img>
		<img id=middle src=../ui/jauge_middle.png on-load='test' hidden></img>
		<img id=end src=../ui/jauge_end.png on-load='test' hidden></img>

		<img id=red src=../ui/jauge_red.png on-load='test' hidden></img>

		<div class="horizontal">
			<div class="horizontal flexchild">
				<iron-image src={{character.character.attrs.image.src}}></iron-image>
				<paper-item>{{character.attrs.name}}</paper-item>
				<paper-menu-button>
				<paper-icon-button icon="mdi:swap-horizontal" class="dropdown-trigger"></paper-icon-button>
				<paper-menu class="dropdown-content vertical">
					<template is="dom-repeat" items={{getJobList(jobs)}}>
						<paper-item>{{item}}</paper-item>
					</template>
				  </paper-menu>
				</paper-menu-button>
			</div>

			<div class="vertical green">
				<paper-item>lvl: {{character.attrs.lvl}}</paper-item>
				<canvas style="display: block" width="100" height="20"></canvas>
			</div>

		</div>

		<div class="horizontal">
			<div class="flexchild">
				<paper-item>HP: {{do(character, 'life')}} / {{character.attrs.hp_max}}</paper-item>
				<div>
					<paper-item class=inline>Job: {{character.attrs.job.name}}</paper-item>
					<paper-item class=inline>Job lvl: {{do(character, 'joblvl')}}</paper-item>
				</div>
				<div>
					<paper-item class=inline>Strength: {{character.attrs.strength}}</paper-item>
					<paper-item class=inline>Agility: {{character.attrs.agility}}</paper-item>
					<paper-item class=inline>Vitality: {{character.attrs.vitality}}</paper-item>
					<paper-item class=inline>Intellect: {{character.attrs.intellect}}</paper-item>
					<paper-item class=inline>Mind: {{character.attrs.mind}}</paper-item>
				</div>

				<template is="dom-if" if={{character.attrs.job.mps.1}}>
				<table>
				<tr><td>
					<paper-item>Magic:</paper-item>
				</td>
				<template is="dom-repeat" items={{character.attrs.job.mps.1}}>
					<td>
						<paper-item>lvl {{incr(index)}}</paper-item>
					</td>
				</template>
				</tr>
				<tr><td></td>
				<template is="dom-repeat" items={{character.attrs.job.mps.1}}>
					<td>
						<paper-item>{{item}}</paper-item>
					</td>
				</template>
				</tr>
				</table>
				</template>
			</div>
			<adebray-skill-tree width=200 height=200 character={{character}}></adebray-skill-tree>
		</div>


	</template>
	<script>
		Polymer({
			is: 'adebray-character-card',

			properties: {
				character: {
					type: Object,
					notify: true
				},
				jobs: {
					type: Object,
					value: jobs
				}
			},

			listeners: {
				'iron-select': 'log'
			},

			log: function (e) {
				this.character.changejob(Object.keys(jobs)[e.target.selected], (c) => {
					this.notifyPath('character.character.attrs.image.src')
					this.fire('team-modified', c)
				})
			},

			incr: function (i) { return i + 1 },

			getJobList: function (jobs) {
				return Object.keys(jobs)
			},


			getFaceImage: function (c) {
				if (c)
					return c['down'].src
			},

			do: function (obj, method) {
				if (obj && obj[method])
					return obj[method]()
			},

			changeJob: function (e) {
				console.log(this.character)
				// c.changeJob()
			},

			test: function (e) {
				if (e.target.id == 'start')
					this._s = true
				if (e.target.id == 'middle')
					this._m = true
				if (e.target.id == 'end')
					this._e = true
				if (e.target.id == 'red')
					this._r = true

				if (this._s && this._m && this._e && this._r) {
					let canvas = this.querySelector('canvas')
					let ctx = canvas.getContext('2d')

					let start = this.querySelector('#start')
					let mid = this.querySelector('#middle')
					let end = this.querySelector('#end')
					let red = this.querySelector('#red')
					ctx.drawImage(start, 0, 0)

					var i = start.width
					while (i + mid.width < canvas.width) {
						ctx.drawImage(mid, i, 0)
						i += mid.width
					}

					i = 9
					let ratio = Math.round(this.character.attrs.experience / this.character.attrs.experience_max * (canvas.width - 18))
					while (i < ratio) {
						ctx.drawImage(red, i, 3)
						i += red.width
					}

					ctx.drawImage(end, canvas.width - end.width, 0)
				}
			}

		});
	</script>
</dom-module>
