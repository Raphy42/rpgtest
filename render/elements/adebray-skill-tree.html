<link rel=import href="adebray-color/color-hash.html">
<link rel=import href="adebray-color/color-dot.html">

<dom-module id="adebray-skill-tree">
	<template>
		<style>
			:host {
				display: inline-block;
				border: 1px solid black;
			}
		</style>

		<div id=head>
			<color-hash></color-hash>
		</div>

		<div class=centered>
			<div id='container'></div>
		</div>

	</template>
	<script>
	Polymer({
		is: 'adebray-skill-tree',

		properties: {
			character: Object,
			width: {
				type: Number,
				value: 200
			},
			height: {
				type: Number,
				value: 200
			},
			side: {
				type: Number,
				value: 4
			},
			scale: {
				type: Number,
				value: 0.25
			},
			depth: Number,
		},

		getSeed: function (x, y) {
			x = Math.abs(x)
			y = Math.abs(y)
			return this.seed[x % 1024][y % 1024]
		},

		attached: function () {
			let flatted = (o) => Object.keys(o).map( k => Object.keys(o[k]).map( e => {
				k = k.match(/\w+/)[0]
				e = e.toLowerCase()
				return `${k}.${e}`
			}))

			let test = flatted(Magic).concat( flatted({
				"Combat": {
					// "Bare Hands": null,
					// "Harp": null,
					"Bow": null,
					"Other": null
				}
			}))
			test = [].concat.apply([], test)

			let harmonizer = new Harmonizer()
			let p = []
			for (let i = 0; i < 360; i += 360 / test.length) {
				p.push( parseInt(i) )
			}

			let h = harmonizer.harmonize('#c820f1', p)
			let colors = test.map( (e, i) => {
				let dot = document.createElement('color-dot')
				dot.customStyle['--custom-color'] = h[i]
				dot.text = e
				this.appendChild(dot)

				return {
					text: e,
					color: dot.customStyle['--custom-color']
				}
			})
			// console.log(colors)

			let stage = new Konva.Stage({
				container : this.$['container'],
				width: this.width,
				height: this.height
			})
			let layer = new Konva.Layer({
				draggable: true
			})

			stage.on('contentWheel', (e) => {
				this.scale += e.evt.deltaY / 100
				layer.scale({x: this.scale, y: this.scale})
				layer.draw()
			})

			stage.add(layer)
			layer.scale({x: this.scale, y: this.scale})

			if (!this.character)
			{
				let t = new Tree( new Seed({size: 128}) )
				for (var i = 0; i < this.depth; i++) {
					t.levelup()
				}
				console.log('childlen:', t.children.length)
				console.log('stacklen:', t.stack.length)

				layer.add(t)
				layer.x( stage.width() / 2)
				layer.y( stage.height() / 2)
				layer.draw()
			}
			else
			{
				layer.add(this.character.attrs.tree)
				layer.x( stage.width() / 2)
				layer.y( stage.height() / 2)
				layer.draw()
			}
		}
	})
	</script>
</dom-module>
