<link rel=import href=../bower_components/iron-a11y-keys/iron-a11y-keys.html>
<link rel=import href=../bower_components/iron-localstorage/iron-localstorage.html>
<link rel=import href=../bower_components/iron-list/iron-list.html>
<link rel=import href=../bower_components/paper-item/paper-item.html>
<link rel=import href=../bower_components/paper-input/paper-input.html>
<link rel=import href=../bower_components/iron-icons/iron-icons.html>
<link rel=import href=../bower_components/iron-image/iron-image.html>
<link rel=import href=../bower_components/iron-list/iron-list.html>
<link rel=import href=../bower_components/paper-icon-button/paper-icon-button.html>

<link rel=import href=mdi.html>
<!-- <link rel=import href=adebray-config.html> -->
<link rel=import href=adebray-character-menu.html>

<script type="text/javascript" src="../scripts/BattleStage.js"></script>
<script type="text/javascript" src="../scripts/Character.js"></script>

<dom-module id="adebray-work">
	<template>

		<style>
			:host {
				padding: 8px;
				margin: 4px;
				display: block;
			}

			.centered {
				display: block;
				@apply(--layout-horizontal);
				@apply(--layout-center-justified);
			}

			.float {
				z-index: 1;
				background: lightgrey;
				position: absolute
			}

			.mode {
				left: 48px;
				position: absolute;
				z-index: 1;
			}

			.portrait {
				display: inline-block;
				border: 1px solid black;
				image-rendering: pixelated;
				width: 100px;
				height: 100px;
			}

			paper-tabs paper-tab {
				border: 1px solid black;
				display: inline-block;
			}

			.horizontal {
				@apply(--layout-horizontal);
			}
		</style>

		<iron-a11y-keys target=[[target]] keys="1" on-keys-pressed="selectFight"></iron-a11y-keys>
		<iron-a11y-keys target=[[target]] keys="2" on-keys-pressed="selectItem"></iron-a11y-keys>
		<iron-a11y-keys target=[[target]] keys="3" on-keys-pressed="selectMenu"></iron-a11y-keys>
		<iron-a11y-keys target=[[target]] keys="space" on-keys-pressed="toggle"></iron-a11y-keys>

		<template is="dom-if" if="{{isOn(mode)}}">
			<paper-icon-button icon="mdi:pause" on-tap="toggle"></paper-icon-button>
		</template>
		<template is="dom-if" if="{{isOff(mode)}}">
			<paper-icon-button icon="mdi:play" on-tap="toggle"></paper-icon-button>
		</template>

		<!-- <adebray-config></adebray-config> -->
<!--
 		<div class="float">
			<paper-item>a dluhdil uhawlidu hawl duahiwudh lawiuhd laiu </paper-item>
			<paper-item>Item 2</paper-item>
			<paper-item>Item 3</paper-item>
			<paper-item>Item 4</paper-item>
		</div>
-->

		<!-- <iron-localstorage id='storage' name="{{key}}" value="{{storage}}"></iron-localstorage> -->

		<div class=centered>
			<div id='container'></div>
		</div>

		<div style='top: -100px'>
			<div id='content' class='horizontal centered'>
				<iron-image class='portrait' src="{{selected.character.attrs.image.src}}" preload sizing="cover"></iron-image>
				<paper-item id=fight>Fight</paper-item>
				<paper-item id=item>Item</paper-item>
				<paper-item id=menu>Menu</paper-item>
			</div>

			<div class="layout horizontal centered">
				<paper-item style="width: 15em">HP: {{do(selected, 'life')}} / {{selected.attrs.hp_max}}</paper-item>
				<paper-item style="width: 15em">lvl: {{selected.attrs.lvl}}</paper-item>
				<paper-item style="width: 15em">XP: {{do(selected, 'experience')}} / {{selected.attrs.experience_max}}</paper-item>
			</div>
			<div class="layout horizontal centered">
				<paper-item style="width: 15em">job: {{selected.attrs.job.name}}</paper-item>
				<paper-item style="width: 15em">joblvl: {{do(selected, 'joblvl')}}</paper-item>
				<paper-item style="width: 15em">jobpoints: {{do(selected, 'jobpoints')}}</paper-item>
			</div>

			<div class="layout horizontal centered">
				<div style="width: 15em">
					<paper-item>strength: {{selected.attrs.strength}}</paper-item>
					<paper-item>agility: {{selected.attrs.agility}}</paper-item>
					<paper-item>vitality: {{selected.attrs.vitality}}</paper-item>
					<paper-item>intellect: {{selected.attrs.intellect}}</paper-item>
					<paper-item>mind: {{selected.attrs.mind}}</paper-item>
				</div>
				<div style="width: 15em">
					<paper-item>attack: {{do(selected, 'attack')}}</paper-item>
					<paper-item>defense: {{do(selected, 'defense')}}</paper-item>
					<paper-item>magic_defense: {{do(selected, 'magic_defense')}}</paper-item>
				</div>
				<div style="width: 15em">
					<paper-item>head: {{selected.attrs.head.name}}</paper-item>
					<paper-item>body: {{selected.attrs.body.name}}</paper-item>
					<paper-item>arms: {{selected.attrs.arms.name}}</paper-item>
					<paper-item>left: {{selected.attrs.left.name}}</paper-item>
					<paper-item>right: {{selected.attrs.right.name}}</paper-item>
				</div>
			</div>
		</div>

	</template>

	<script>
		Polymer({
			is: 'adebray-work',

			properties: {
				 userInput: {
				    type: String,
				    notify: true,
				  },
				target: {
					type: Object,
					value: function() {
						return document
					}
				},
				teamA: {
					type: Array,
					value: [
						{
							position: 6,
							image: 'images2/combat_dummy/BODY_animation.png',
							class: 'Freelancer',
							body: items.Vest,
							left: items.Knife,
 						},{
							position: 6,
							image: 'images2/combat_dummy/test.png',
							class: 'Freelancer',
							left: items.Knife,
 						},{
							position: 6,
							image: 'images2/combat_dummy/BODY_animation.png',
							class: 'Freelancer',
							body: items.Vest,
							left: items.Knife,
 						},{
							position: 6,
							image: 'images2/combat_dummy/test.png',
							class: 'Freelancer',
							left: items.Knife,
 						},{
							position: 6,
							image: 'images2/combat_dummy/BODY_animation.png',
							class: 'Freelancer',
							body: items.Vest,
							left: items.Knife,
 						},{
							position: 6,
							image: 'images2/combat_dummy/test.png',
							class: 'Freelancer',
							left: items.Knife,
 						},{
							position: 6,
							image: 'images2/combat_dummy/BODY_animation.png',
							class: 'Freelancer',
							body: items.Vest,
							left: items.Knife,
 						},{
							position: 6,
							image: 'images2/combat_dummy/test.png',
							class: 'Freelancer',
							left: items.Knife,
 						}
					]
				},
				teamB: {
					type: Array,
					value: [
						{

							position: 2,
							image: 'images2/combat_dummy/test.png',
							class: 'Freelancer'
						},{

							position: 2,
							image: 'images2/combat_dummy/BODY_animation.png',
							class: 'Freelancer'
						},{

							position: 2,
							image: 'images2/combat_dummy/test.png',
							class: 'Freelancer'
						},{

							position: 2,
							image: 'images2/combat_dummy/BODY_animation.png',
							class: 'Freelancer'
						},{

							position: 2,
							image: 'images2/combat_dummy/test.png',
							class: 'Freelancer'
						},{

							position: 2,
							image: 'images2/combat_dummy/BODY_animation.png',
							class: 'Freelancer'
						},{

							position: 2,
							image: 'images2/combat_dummy/test.png',
							class: 'Freelancer'
						},{

							position: 2,
							image: 'images2/combat_dummy/BODY_animation.png',
							class: 'Freelancer'
						}
					]
				},
				key: String,
				storage: Object,

				mode: {
					type: Boolean,
					value: true
				},
				stack: Array,
				selected: {
					type: Object,
					value: {
						children: [ { attrs: { image: { src: "" } } } ]
					}
				}
			},

			observers: [
				'isSelected(selected)'
			],

			do: function (obj, method) {
				if (obj[method])
					return obj[method]()
			},

			isOn: function (mode) {
				return mode === true
			},

			isOff: function (mode) {
				return mode === false
			},

			toggle: function () {
				this.mode = !this.mode
			},

			selectFight: function (e) {
				if (!this.$.fight.focused)
					this.$.fight.focus()
				else
			        this.$.fight.blur();
			},
			selectItem: function () {
				if (!this.$.item.focused)
					this.$.item.focus()
				else
			        this.$.item.blur();
			},
			selectMenu: function () {
				if (!this.$.menu.focused)
					this.$.menu.focus()
				else
			        this.$.menu.blur();
			},

			isSelected: function (s) {
				if (s instanceof Konva.Group && s.attrs.ready == true)
					this.querySelectorAll('#content > paper-item').forEach( e => {
						e.disabled = false
					})
				else if (s instanceof Konva.Group && s.attrs.ready == false) {
					this.$.fight.disabled = true
					this.$.item.disabled = true
					this.$.menu.disabled = false
				}
				else
					this.querySelectorAll('#content > paper-item').forEach( e => {
						e.disabled = true
					})
			},

			// fightHandler: function (e) {
			// 	console.log( config.Number_of_Hits(this.selected) )
			// },

			attached: function () {
				this.$.fight.keyEventTarget = null
				this.$.item.keyEventTarget = null
				this.$.menu.keyEventTarget = null

				var stage = new Konva.Stage({
					container : this.$$('#container'),
					width: 800,
					height: 600
				})
				layer = new Konva.Layer()

				stage.add(layer)

				var back = new Konva.Rect({
					width: 800,
					height: 600,
					fill: 'rgba(127, 127, 127, 0)'
				})

				back.on('click', (e) => {
					// console.log('back click', e)
					// e.cancelBubble = true
					if (this.selected.attrs) {
						this.selected.lock = false
						this.selected.children[0].hide()
						layer.draw()
					}
					this.set('selected', {
						children: [ { attrs: { image: { src: "" } } } ]
					})
				})

				layer.add(back)

				  bs = new BattleStage({
					layer,
					teamA: this.teamA,
					teamB: this.teamB,
					callback: (bs) => {
						this.set('stack', bs.stack)
						// render()
					}
				})

				bs.run()
				// let render = () => {
				// 	if (this.mode) {
				// 		bs.update()
				// 	}
				// 	requestAnimationFrame(render)
				// }

				// render()
			}
		});
	</script>
</dom-module>
